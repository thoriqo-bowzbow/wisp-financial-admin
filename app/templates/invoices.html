{% extends "base.html" %}
{% block title %}Manajemen Tagihan{% endblock %}
{% block content %}
  <div class="card mb-4">
    <div class="card-header">Generate Tagihan Bulanan</div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('generate_invoices') }}">
        {{ gen_form.hidden_tag() }}
        <div class="row align-items-end">
          <div class="col-md-4"><div class="mb-3">{{ gen_form.bulan.label(class="form-label") }}{{ gen_form.bulan(class="form-select") }}</div></div>
          <div class="col-md-4"><div class="mb-3">{{ gen_form.tahun.label(class="form-label") }}{{ gen_form.tahun(class="form-control") }}</div></div>
          <div class="col-md-4"><div class="mb-3">{{ gen_form.submit(class="btn btn-primary w-100") }}</div></div>
        </div>
      </form>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h1>Daftar Tagihan</h1></div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                    <th>Pelanggan</th><th>Periode</th><th>Jumlah</th><th>Status</th><th>Tgl Lunas</th><th>Bukti</th><th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                    <td>{{ invoice.customer.nama if invoice.customer else 'PELANGGAN DIHAPUS' }}</td>
                    <td>{{ "{:02d}".format(invoice.bulan) }}/{{ invoice.tahun }}</td>
                    <td>Rp {{ "{:,.0f}".format(invoice.jumlah) }}</td>
                    <td>
                        {% if invoice.status == 'Lunas' %}<span class="badge bg-success">Lunas</span>
                        {% else %}<span class="badge bg-danger">Belum Lunas</span>{% endif %}
                    </td>
                    <td>{{ invoice.tanggal_lunas.strftime('%d-%m-%Y') if invoice.tanggal_lunas else '-' }}</td>
                    <td>
                        {% if invoice.bukti_pembayaran %}<a href="{{ url_for('static', filename='uploads/' + invoice.bukti_pembayaran) }}" target="_blank">Lihat</a>
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if invoice.status != 'Lunas' %}
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#payModal{{ invoice.id }}">Bayar</button>
                        {% endif %}
                        <form method="POST" action="{{ url_for('delete_invoice', invoice_id=invoice.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Anda yakin ingin menghapus tagihan ini? Ini tidak bisa dibatalkan.')">Hapus</button>
                        </form>
                    </td>
                    </tr>
                    <div class="modal fade" id="payModal{{ invoice.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Pembayaran untuk {{ invoice.customer.nama if invoice.customer else 'N/A' }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="POST" action="{{ url_for('pay_invoice', invoice_id=invoice.id) }}" enctype="multipart/form-data">
                            {{ payment_form.hidden_tag() }}
                            <div class="modal-body">
                                <p>Tagihan periode <strong>{{ "{:02d}".format(invoice.bulan) }}/{{ invoice.tahun }}</strong> sebesar <strong>Rp {{ "{:,.0f}".format(invoice.jumlah) }}</strong></p>
                                <div class="mb-3">{{ payment_form.tanggal_lunas.label(class="form-label") }}{{ payment_form.tanggal_lunas(class="form-control") }}</div>
                                <div class="mb-3">{{ payment_form.nota.label(class="form-label") }}{{ payment_form.nota(class="form-control") }}</div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                {{ payment_form.submit(class="btn btn-primary") }}
                            </div>
                        </form>
                        </div>
                    </div>
                    </div>
                    {% else %}
                    <tr><td colspan="7" class="text-center">Belum ada data tagihan.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
  </div>
{% endblock %}
